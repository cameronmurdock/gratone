<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Calendar</title>
    <!-- Meta Tag for Responsive Design -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- FullCalendar CSS -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
    <!-- Custom Styles -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        #calendar {
            max-width: 900px;
            margin: 50px auto;
            padding: 0 10px;
        }
        /* Custom event styling */
        .fc-event {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="calendar"></div>

    <!-- User Data Script -->
    <script>
        // User Data Object
        const user = {
            id: "1",
            name: "Alice Johnson",
            email: "alice.johnson@example.com",
            events: [
                {
                    id: "event1",
                    title: "Community Meeting",
                    start: "2024-11-22T10:00:00",
                    end: "2024-11-22T11:30:00",
                    description: "A meeting to discuss upcoming community projects.",
                    location: "Community Center",
                    url: ""
                },
                {
                    id: "event2",
                    title: "Urban Gardening Workshop",
                    start: "2024-11-25T14:00:00",
                    end: "2024-11-25T16:00:00",
                    description: "Learn about sustainable gardening in urban spaces.",
                    location: "City Park",
                    url: ""
                },
                {
                    id: "event3",
                    title: "Festival Setup",
                    start: "2024-11-28T09:00:00",
                    end: "2024-11-28T12:00:00",
                    description: "Preparing for the annual community festival.",
                    location: "Main Street",
                    url: ""
                }
            ]
        };
    </script>

    <!-- FullCalendar and Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
    <!-- Date Formatting Library (optional, for better date handling) -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.0/build/global/luxon.min.js"></script>

    <!-- Main Script -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');

            // Initialize the calendar
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                selectable: true,
                editable: true,
                eventClick: function (info) {
                    // Display event details
                    const eventObj = info.event.extendedProps;
                    alert(
                        `Title: ${info.event.title}\n` +
                        `Start: ${info.event.start.toLocaleString()}\n` +
                        `End: ${info.event.end.toLocaleString()}\n` +
                        `Description: ${eventObj.description}\n` +
                        `Location: ${eventObj.location}`
                    );
                },
                select: function (info) {
                    // Create a new event
                    const title = prompt('Enter event title:');
                    if (title) {
                        const newEvent = {
                            id: `event${Date.now()}`,
                            title: title,
                            start: info.startStr,
                            end: info.endStr,
                            description: '',
                            location: '',
                            url: ''
                        };
                        calendar.addEvent(newEvent);
                        user.events.push(newEvent);
                    }
                    calendar.unselect();
                },
                events: user.events,
                eventDataTransform: function (eventData) {
                    // Transform event data to match FullCalendar's schema
                    return {
                        id: eventData.id,
                        title: eventData.title,
                        start: eventData.start,
                        end: eventData.end,
                        description: eventData.description,
                        location: eventData.location,
                        url: eventData.url
                    };
                },
                eventDidMount: function (info) {
                    // Tooltip or other customizations can be added here
                }
            });

            calendar.render();

            // Function to export calendar to iCal format
            function exportToICal() {
                let icsEvents = user.events.map(event => {
                    return `BEGIN:VEVENT
UID:${event.id}
SUMMARY:${event.title}
DESCRIPTION:${event.description}
LOCATION:${event.location}
DTSTART:${formatDateForICal(event.start)}
DTEND:${formatDateForICal(event.end)}
END:VEVENT`;
                }).join('\n');

                let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//YourAppName//EN
${icsEvents}
END:VCALENDAR`;

                // Create a blob and download the iCal file
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${user.name.replace(' ', '_')}_Calendar.ics`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            // Helper function to format date for iCal
            function formatDateForICal(dateStr) {
                const date = new Date(dateStr);
                const pad = (num) => String(num).padStart(2, '0');
                const YYYY = date.getUTCFullYear();
                const MM = pad(date.getUTCMonth() + 1);
                const DD = pad(date.getUTCDate());
                const HH = pad(date.getUTCHours());
                const mm = pad(date.getUTCMinutes());
                const ss = pad(date.getUTCSeconds());
                return `${YYYY}${MM}${DD}T${HH}${mm}${ss}Z`;
            }

            // Add Export to Google Calendar Button
            const exportBtn = document.createElement('button');
            exportBtn.textContent = 'Export to Google Calendar';
            exportBtn.style.display = 'block';
            exportBtn.style.margin = '20px auto';
            exportBtn.style.padding = '10px 20px';
            exportBtn.style.fontSize = '16px';
            exportBtn.onclick = function () {
                const url = generateGoogleCalendarURL(user.events);
                window.open(url, '_blank');
            };
            document.body.insertBefore(exportBtn, calendarEl);

            // Function to generate Google Calendar URL for importing events
            function generateGoogleCalendarURL(events) {
                // Create a base URL
                let url = 'https://calendar.google.com/calendar/render?action=TEMPLATE';
                if (events.length > 0) {
                    const event = events[0]; // For simplicity, we will export only the first event
                    const start = new Date(event.start).toISOString().replace(/-|:|\.\d\d\d/g, '');
                    const end = new Date(event.end).toISOString().replace(/-|:|\.\d\d\d/g, '');
                    url += `&text=${encodeURIComponent(event.title)}`;
                    url += `&dates=${start}/${end}`;
                    url += `&details=${encodeURIComponent(event.description)}`;
                    url += `&location=${encodeURIComponent(event.location)}`;
                }
                return url;
            }
        });
    </script>
</body>
</html>
